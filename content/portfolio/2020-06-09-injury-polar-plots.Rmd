---
title: Injury Polar Plots
author: Lars Maurath
date: '2020-06-09'
slug: injury-polar-plots
categories: []
tags:
  - ggplot
  - injuries
image: 'img/portfolio/injury_polar.png'
showonlyimage: no
---
Injury data has been a bit of a guilty pleasure for me [recently](https://www.thesignificantgame.com/portfolio/quantifying-injury-rates/){target="_blank"}. Browsing through some of the data from Transfermarkt I looked into different ways of visualizing it. Specifically I was focussed on highlighting injury lengths and their distribution over a player's career.

![*Screenshot from transfermarkt.com*](/portfolio/2020-06-09-injury-polar-plots_files/injury_history.png){ width=50% }

This resulted in the below viz for Marco Reus which is inspired by how I view the (European) football calendar: running counter-clockwise and with the summer break at 6 o'clock. Each ring in the polar plot corresponds to one season moving from the first season on the inside to the most recent season as the outer ring. On the right half there is some space for a player portrait, some commentary and an overview on missed games per season.

```{r echo=FALSE}
blogdown::shortcode('tweet', '1264554303546679296')
```

### Form Over Function


Looking at the polar chart it is clear that it looks appealing (at least in my view), but it is hard to read. I do not think that it is hard to understand what is shown on a high level, but following individual seasons by ring or comparing injury durations across seasons is very hard. In other words it commits the cardinal sin of prioritizing *form over function*.

Even the CRAN documentation for the *coord_polar* function explicitly warns of this and they are subtle about it:

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
NOTE: Use these plots with caution - polar coordinates has major perceptual problems. The main point of these examples is to demonstrate how these common plots can be described in the grammar. Use with EXTREME caution (from documentation of *coord_polar {ggplot2}*).
</div>

### Bar Chart Representation

A more conservative approach to representing this data is to use a bar chart. This choice addresses the two problems highlighted above but definitely reduces the visible appeal. See below for Holger Badstuber:

```{r echo=FALSE}
blogdown::shortcode('tweet', '1264618842640310273')
```


```{r Import Libraries, message=FALSE, warning=FALSE, include=TRUE, tidy=TRUE}
library(tidyverse)
library(lubridate)
library(cowplot)
library(glue)
library(ggtext)
library(gridExtra)
library(patchwork)
```

```{r Circle Image Func, include=FALSE}
circle_img <- function(path_to_img){

library(magick)
library(plotrix)

png(tf <- tempfile(fileext = ".png"), 1000, 1000)
par(mar = rep(0,4), yaxs="i", xaxs="i")
plot(0, type = "n", ylim = c(0,1), xlim=c(0,1), axes=F, xlab=NA, ylab=NA)
plotrix::draw.circle(.5,0.5,.5, col="black")
dev.off()

img <- image_read(path_to_img)
mask <- image_read(tf)
mask <- image_scale(mask, as.character(image_info(img)$width))

player_img <- image_composite(mask, img, "plus") 
}

# plot <- ggdraw() + 
#   draw_image(circle_img(path_to_img), x = 0.41, y = 0.385, width = 0.18, height = 0.18) +
#   draw_plot(plot)
```

```{r Date to Season Func, include=FALSE}
date_to_season <- function(date){
  month <- month(date)
  year <- year(date)
  
  if(month < 7){
    season <- paste0(as.character(year-1), "/", as.character(year))
  } else{
    season <- paste0(as.character(year), "/", as.character(year+1))
  }
  return(season)
}
```

```{r Load data and define parameters, include=FALSE}
# path_to_img <- "https://tmssl.akamaized.net/images/portrait/header/35207-1534236293.jpg?lm=1534236362"
# player_name <- "Marco Reus"
# data <- read_csv("~/Documents/R/injury.csv", col_types = "cccn")
# highlight_col <- "gold"
# muted_col <- "grey50"
# background_col <- "grey10"
# text_col <- "white"

  # annotate("text", x = 0, y = 0.8, colour = text_col, size = 2.5, hjust = 0, label = "- Sidelined since February with a muscle injury") + 
  # annotate("text", x = 0, y = 0.5, colour = text_col, size = 2.5, hjust = 0, label = "- Missed 13 games so far this season") + 
  # annotate("text", x = 0, y = 0.2, colour = text_col, size = 2.5, hjust = 0, label = "- Longest injury break from May17 to Jan18 \n with a ruptured ACL") +

path_to_img <- "https://tmssl.akamaized.net/images/portrait/header/8198-1568120625.jpg?lm=1568120652"
player_name <- "Cristiano Ronaldo"
data <- read_csv("~/Documents/R/injury_ronaldo.csv", col_types = "cccn")
highlight_col <- "red3"
muted_col <- "grey80"
background_col <- "grey10"
text_col <- "white"

# path_to_img <- "https://tmssl.akamaized.net/images/portrait/header/28003-1510231943.jpg?lm=1510231982"
# player_name <- "Lionel Messi"
# data <- read_csv("~/Documents/R/injury_messi.csv", col_types = "cccn")
# highlight_col <- "midnightblue"
# muted_col <- "grey"
# background_col <- "grey10"
# text_col <- "white"

# path_to_img <- "https://tmssl.akamaized.net/images/portrait/header/54659-1532077316.jpg?lm=1532077429"
# player_name <- "Holger Badstuber"
# data <- read_csv("~/Documents/R/injury_badstuber.csv", col_types = "cccn")
# highlight_col <- "red3"
# muted_col <- "grey80"
# background_col <- "grey10"
# text_col <- "white"

# annotate("text", x = 0, y = 0.8, colour = text_col, size = 2.5, hjust = 0, label = "- Tore his ACL in Dec12 and again during recovery") +
# annotate("text", x = 0, y = 0.5, colour = text_col, size = 2.5, hjust = 0, label = "- Shortly after his comeback in Aug14 tore a tendon and missed \n the rest of the season") +
# annotate("text", x = 0, y = 0.2, colour = text_col, size = 2.5, hjust = 0, label = "- Thankfully more stable since he left Bayern") +
```

```{r Prepare Missed Games Table, include=FALSE}
data_missed <- data %>%
  distinct() %>%
  mutate(from = as.Date(from, "%d/%m/%Y"), to = as.Date(to, "%d/%m/%Y")) %>%
  rowwise() %>%
  mutate(season = date_to_season(from)) %>%
  ungroup()

# If not injury takes place during a season we need to manually add it

missing_seasons <- unlist(setdiff(
  map2(
    seq(from = min(year(data_missed$from)), to = max(year(data_missed$from))-1),
    seq(from = min(year(data_missed$from))+1, to = max(year(data_missed$from))),
    function(x,y){paste0(as.character(x), "/", as.character(y))}
  ), 
  unique(data$season)))

for(season in missing_seasons){
  data_missed <- data_missed %>%
    add_row(Verletzung = "Gesund",
            season = season,
            missed = 0) %>%
    add_row(Verletzung = "Sommerpause",
            season = season,
            missed = 0)
}

missed_table <- data_missed %>%
  mutate(season = paste0(substr(season, 3, 4), "/", substr(season, 8, 9))) %>%
  group_by(season) %>%
  summarize(missed_sum = sum(missed))
```

```{r Prepare Data, include=FALSE}
data_plot <- data %>%
  select(-missed) %>%
  distinct() %>%
  mutate(from = as.Date(from, "%d/%m/%Y"), to = as.Date(to, "%d/%m/%Y")) %>%
  add_row(Verletzung = "Gesund", from = max(.$to)+1, to = today()) %>%
  rowwise() %>%
  mutate(from = if_else(month(from) == 7, ymd(paste0(as.character(year(from)), "0801")), from)) %>%
  mutate(to = if_else(month(to) == 7, ymd(paste0(as.character(year(to)), "0630")), to)) %>%
  mutate(season = date_to_season(from)) %>%
  mutate(from_day = from - ymd(paste0(substr(season, 1, 4), "0801"))) %>%
  mutate(to_day = to - ymd(paste0(substr(season, 1, 4), "0801"))) %>%
  # Split injuries that cross seasons
  split(.$from) %>%
  map_dfr(~ add_row(.x, 
                    Verletzung = last(.$Verletzung), 
                    from = if_else(last(.$to_day) > 365, 
                                   ymd(paste0(substr(last(.$season), 6, 9), "0801")), 
                                   last(.$to)), to = last(.$to))) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(season = date_to_season(from)) %>%
  mutate(from_day = from - ymd(paste0(substr(season, 1, 4), "0801"))) %>%
  mutate(to_day = to - ymd(paste0(substr(season, 1, 4), "0801"))) %>%
  mutate(to = if_else(to_day > 365, ymd(paste0(substr(season, 6, 9), "0630")), to)) %>%
  filter(from_day != to_day) %>%
  # Add start of season
  split(.$season) %>%
  map_dfr(~ add_row(.x, 
                    Verletzung = "Gesund", 
                    season = last(.$season), 
                    from = ymd(paste0(substr(first(.$season), 1, 4), "0801")), 
                    to = min(.$from) - 1, 
                    .before = 0)) %>%
  # Add end of season
  split(.$season) %>%
  map_dfr(~ add_row(.x, 
                    Verletzung = "Gesund", 
                    season = last(.$season), 
                    from = max(.$to) + 1, 
                    to = ymd(paste0(substr(last(.$season), 6, 9), "0630")))) %>%
  # Add healthy filler periods
  split(.$from) %>%
  map_dfr(~ add_row(.x, Verletzung = "Gesund", season = last(.$season))) %>%
  ungroup() %>%
  mutate(from = if_else(is.na(from), lag(to)+1, from)) %>%
  mutate(to = if_else(is.na(to), lead(from)-1, to)) %>%
  mutate(from_day = from - ymd(paste0(substr(season, 1, 4), "0801"))) %>%
  mutate(to_day = to - ymd(paste0(substr(season, 1, 4), "0801"))) %>%
  mutate(day_diff = as.numeric(to_day - from_day + 1)) %>%
  filter(day_diff > 0,  month(to) != 7) %>%
  mutate(category = paste0(Verletzung, "_", as.character(row_number()))) %>%
  mutate(color = if_else(startsWith(category, "Gesund"), muted_col, highlight_col)) %>%
  # Add summer break
  split(.$season) %>%
  map_dfr(~ add_row(.x, 
                    Verletzung = "Sommerpause", 
                    from = ymd(paste0(substr(last(.$season), 6, 9), "0701")),
                    to = ymd(paste0(substr(last(.$season), 6, 9), "0731")),
                    season = last(.$season),
                    day_diff = 31,
                    category = paste0("Sommerpause", "_", last(.$season)),
                    color = background_col)) %>%
  filter(to <= today())

missing_seasons <- unlist(setdiff(
  map2(
    seq(from = min(year(data_plot$from)), to = max(year(data_plot$from))-1),
    seq(from = min(year(data_plot$from))+1, to = max(year(data_plot$from))),
    function(x,y){paste0(as.character(x), "/", as.character(y))}
  ), 
  unique(data_plot$season)))

for(season in missing_seasons){
  data_plot <- data_plot %>%
    add_row(Verletzung = "Gesund",
            season = season,
            day_diff = 334,
            category = paste0("Gesund_", season),
            color = muted_col) %>%
    add_row(Verletzung = "Sommerpause",
            season = season,
            day_diff = 31,
            category = paste0("Sommerpause_", season),
            color = background_col)
}

data_plot <- data_plot %>% arrange(season)
```

```{r Plot Chart}
data_plot$category <- factor(data_plot$category, levels = rev(data_plot$category))
seasons <- data_plot %>% distinct(season) %>% pull(season)

plot <- ggplot(data_plot, aes(x = season, y = day_diff, fill = category)) +
  geom_bar(width = 0.5, stat = "identity") +
  scale_x_discrete(limits = c("dummy", "dummy", "dummy", "dummy", "dummy", seasons, "annotation")) +
  scale_fill_manual(values = tibble::deframe(data_plot %>% select(category, color))) + 
  coord_polar(theta = "y", start = 6.5/6*pi, direction = -1, clip = "off") +
  annotate("text", x = "annotation", y = 331, colour = text_col, size = 2, label = "June|", angle = 340, fontface = 2) +
  annotate("text", x = "annotation", y = 5, colour = text_col, size = 2, label = "|August", angle = 20, fontface = 2) +
  theme_void() +
  labs(title = glue::glue("{player_name} - <b style = 'color:{highlight_col}'>Injury</b> History")) +
  theme(panel.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.title = element_text(size = 16, color = text_col)) +
  theme(legend.position = "none", plot.title = element_markdown(hjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.ticks.y = element_blank())

for(season in seasons){
  plot <- plot +
    annotate("text", x = season, y = 350, colour = text_col, size = 2, label = paste0(substr(season, 3, 4), "/", substr(season, 8, 9)), fontface = 2)
}
```

```{r Plot Missed Games}

missed_table$season <- factor(missed_table$season, levels = rev(missed_table$season))

missed_plot <- ggplot(missed_table, aes(x = season, y = missed_sum)) +
  geom_col(fill = highlight_col) + 
  ylim(0, 80) +
  geom_text(aes(label = missed_sum), hjust = -0.8, color = text_col, size = 2) +
  coord_flip() +
  labs(title = "Games Missed By Season") +
  theme_minimal() +
  theme(panel.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.title = element_text(size = 10, color = text_col)) +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_text(size = 6, color = text_col), 
        axis.ticks.x = element_blank(), 
        axis.ticks.y = element_blank()) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  annotate("text", x = 1, y = 30, colour = text_col, size = 1.5, hjust = 0, label = "@thesignigame, Data: Transfermarkt.com")
```

```{r Combine Plots}
img_plot <- ggplot() +
  theme_void() +
  theme(panel.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.background = element_rect(fill = background_col, color = background_col)) +
  xlim(0, 1) +
  ylim(0, 1) +
  draw_image(path_to_img, x = 0, y = 0.0, width = 1)

txt_plot <- ggplot() +
  theme_void() +
  theme(panel.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.background = element_rect(fill = background_col, color = background_col)) +
  xlim(0, 1) +
  ylim(0, 1) +
  annotate("text", x = 0, y = 1.0, colour = text_col, size = 2.5, hjust = 0, label = "-----------------------------------------------------------------") + 
  annotate("text", x = 0, y = 0.8, colour = text_col, size = 2.5, hjust = 0, label = "- Tore his ACL in Dec12 and again during recovery") +
  annotate("text", x = 0, y = 0.5, colour = text_col, size = 2.5, hjust = 0, label = "- Shortly after his comeback in Aug14 tore a tendon and missed \n the rest of the season with follow-up injuries") +
  annotate("text", x = 0, y = 0.2, colour = text_col, size = 2.5, hjust = 0, label = "- Thankfully more stable since he left Bayern") +
  annotate("text", x = 0, y = 0.0, colour = text_col, size = 2.5, hjust = 0, label = "-----------------------------------------------------------------")
    
plot + (img_plot / txt_plot / missed_plot)
```

```{r Plot Bar}
plot_bar <- ggplot(data_plot, aes(x = season, y = day_diff, fill = category)) +
  geom_col(width = 0.7) +
  scale_x_discrete(limits = seasons) +
  scale_fill_manual(values = tibble::deframe(data_plot %>% select(category, color))) + 
  coord_flip() +
  annotate("text", x = "annotation", y = 331, colour = text_col, size = 2, label = "June|", fontface = 2) +
  annotate("text", x = "annotation", y = 5, colour = text_col, size = 2, label = "|August", fontface = 2) +
  theme_void() +
  labs(title = glue::glue("{player_name} - <b style = 'color:{highlight_col}'>Injury</b> History")) +
  theme(panel.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.background = element_rect(fill = background_col, color = background_col)) +
  theme(plot.title = element_text(size = 14, color = text_col)) +
  theme(legend.position = "none", plot.title = element_markdown(hjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_text(size = 6, color = text_col),
        axis.ticks.x = element_blank(), 
        axis.ticks.y = element_blank())

plot_bar
```
