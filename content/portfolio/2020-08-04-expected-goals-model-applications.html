---
title: Expected Goals Model - Applications
author: Lars Maurath
date: '2020-08-04'
slug: expected-goals-model-applications
categories: []
tags:
  - Expected Goals
  - xG
  - tidymodels
  - tidyverse
  - tutorial
image: ''
showonlyimage: no
---



<p>xg time line
xG Shots Histogram</p>
<pre class="r"><code>library(dbplyr) # database access
library(DBI) # database access
library(tidyverse) # dataframe manipulation
library(tidymodels) # data processing and modeling

source(&quot;../data/pitch_plots.r&quot;) # helper function to plot the pitch
source(&quot;../data/pitch_plot.r&quot;) # helper function to plot the pitch
source(&quot;../data/standardize_coordinates.r&quot;) # helper function to plot the pitch</code></pre>
<pre class="r"><code>con &lt;- DBI::dbConnect(RSQLite::SQLite(), dbname = &quot;~/Documents/Blog/Data/data.sqlite&quot;)

matches &lt;- tbl(con, &quot;matches&quot;) %&gt;%
  filter(league %in% c(&quot;Germany&quot;)) %&gt;%
  filter(season %in% c(&quot;2018/2019&quot;)) %&gt;%
  collect()

DBI::dbDisconnect(con)

match_ids &lt;- unique(matches$match_id)

con &lt;- DBI::dbConnect(RSQLite::SQLite(), dbname = &quot;~/Documents/Blog/Data/data.sqlite&quot;)

shots &lt;- tbl(con, &quot;events&quot;) %&gt;%
  filter(match_id %in% match_ids) %&gt;%
  filter(teamId == 37) %&gt;%
  filter(isShot == 1) %&gt;%
  collect()

DBI::dbDisconnect(con)

shots &lt;- merge(shots, matches %&gt;% select(match_id, season), by = &quot;match_id&quot;)

shots_ext &lt;- shots %&gt;%
  mutate(isGoal = as.numeric(isGoal)) %&gt;%
  mutate(isGoal = if_else(is.na(isGoal), 0, isGoal)) %&gt;%
  rename(is_goal = isGoal) %&gt;%
  select(location_x, location_y, is_goal, qualifiers, season) %&gt;%
  filter(location_x &gt; 50) %&gt;%
  rowwise() %&gt;%
  mutate(big_chance = if_else(grepl(&quot;BigChance&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(header = if_else(grepl(&quot;Head&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(from_corner = if_else(grepl(&quot;FromCorner&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(from_fk = if_else(grepl(&quot;SetPiece&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(direct_fk = if_else(grepl(&quot;DirectFreekick&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(penalty = if_else(grepl(&quot;Penalty&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(assisted = if_else(grepl(&quot;Assisted&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(intentional_assist = if_else(grepl(&quot;IntentionalAssist&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(fast_break = if_else(grepl(&quot;FastBreak&quot;, qualifiers), 1, 0)) %&gt;%
  ungroup() %&gt;%
  select(-qualifiers) %&gt;%
  filter(header == 0 &amp; from_corner == 0 &amp; from_fk == 0 &amp; direct_fk == 0 &amp; penalty == 0)

distance &lt;- function(x_pos, y_pos){
  x_meters &lt;- 95.4
  y_meters &lt;- 76.25
  
  x_shift &lt;- (100 - x_pos)*x_meters/100
  y_shift &lt;- abs(50 - y_pos)*y_meters/100
  
  distance &lt;- sqrt(x_shift*x_shift + y_shift*y_shift)
}

goal_angle &lt;- function(x_pos, y_pos){
  x_meters &lt;- 95.4
  y_meters &lt;- 76.25

  x_shift &lt;- (100 - x_pos)*x_meters/100
  y_shift &lt;- (50 - y_pos)*y_meters/100
  
  angle &lt;- atan((7.32*x_shift)/(x_shift*x_shift + y_shift*y_shift - (7.32/2)*(7.32/2)))
  angle &lt;- ifelse(angle &lt; 0, angle + pi, angle)
  
  angle_degrees &lt;- angle*180/pi
}

shots_ext &lt;- shots_ext %&gt;%
  rowwise() %&gt;%
  mutate(distance = distance(location_x, location_y)) %&gt;% # distance from goal mid-point
  mutate(angle = goal_angle(location_x, location_y)) %&gt;% # angle based on available goal mouth
  ungroup()

xg_pred &lt;- 
  predict(xg_fit, shots_ext, type = &quot;prob&quot;) %&gt;% 
  bind_cols(shots_ext %&gt;% select(location_x, location_y, is_goal, season)) %&gt;%
  mutate(is_goal_pred = factor(if_else(.pred_1 &gt;= 0.5, 1, 0), levels = c(&quot;1&quot;, &quot;0&quot;)))

xg_pred %&gt;%
  mutate(good_chance = if_else(.pred_1 &gt;= 0.25, 1, 0)) %&gt;%
  group_by(season) %&gt;%
  summarize(good_chance = mean(good_chance), n = n())

ggplot(xg_pred, aes(x = .pred_1, fill = is_goal)) +
  geom_histogram(binwidth = 0.02, aes(y = stat(count / sum(count)))) +
  geom_density(aes(x = .pred_1, y = stat(count / sum(count)))) +
  facet_wrap(~season)</code></pre>
<pre class="r"><code>con &lt;- DBI::dbConnect(RSQLite::SQLite(), dbname = &quot;~/Documents/Blog/Data/data.sqlite&quot;)

matches &lt;- tbl(con, &quot;matches&quot;) %&gt;%
  filter(league %in% c(&quot;Germany&quot;)) %&gt;%
  filter(season %in% c(&quot;2018/2019&quot;, &quot;2017/2018&quot;, &quot;2016/2017&quot;, &quot;2015/2016&quot;, &quot;2014/2015&quot;, &quot;2013/2014&quot;, &quot;2012/2013&quot;, &quot;2011/2012&quot;, &quot;2010/2011&quot;, &quot;2009/2010&quot;, &quot;2008/2009&quot;)) %&gt;%
  collect()

DBI::dbDisconnect(con)

match_ids &lt;- unique(matches$match_id)

con &lt;- DBI::dbConnect(RSQLite::SQLite(), dbname = &quot;~/Documents/Blog/Data/data.sqlite&quot;)

shots &lt;- tbl(con, &quot;events&quot;) %&gt;%
  filter(match_id %in% match_ids) %&gt;%
  filter(teamId == 37) %&gt;%
  filter(isShot == 1) %&gt;%
  collect()

DBI::dbDisconnect(con)

shots &lt;- merge(shots, matches %&gt;% select(match_id, season), by = &quot;match_id&quot;)

shots_ext &lt;- shots %&gt;%
  mutate(isGoal = as.numeric(isGoal)) %&gt;%
  mutate(isGoal = if_else(is.na(isGoal), 0, isGoal)) %&gt;%
  rename(is_goal = isGoal) %&gt;%
  select(location_x, location_y, is_goal, qualifiers, season) %&gt;%
  filter(location_x &gt; 50) %&gt;%
  rowwise() %&gt;%
  mutate(big_chance = if_else(grepl(&quot;BigChance&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(header = if_else(grepl(&quot;Head&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(from_corner = if_else(grepl(&quot;FromCorner&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(from_fk = if_else(grepl(&quot;SetPiece&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(direct_fk = if_else(grepl(&quot;DirectFreekick&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(penalty = if_else(grepl(&quot;Penalty&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(assisted = if_else(grepl(&quot;Assisted&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(intentional_assist = if_else(grepl(&quot;IntentionalAssist&quot;, qualifiers), 1, 0)) %&gt;%
  mutate(fast_break = if_else(grepl(&quot;FastBreak&quot;, qualifiers), 1, 0)) %&gt;%
  ungroup() %&gt;%
  select(-qualifiers) %&gt;%
  filter(header == 0 &amp; from_corner == 0 &amp; from_fk == 0 &amp; direct_fk == 0 &amp; penalty == 0)

data &lt;- shots_ext %&gt;%
  standardize_opta_x(cols = c(&quot;location_x&quot;)) %&gt;%
  standardize_opta_y(cols = c(&quot;location_y&quot;)) %&gt;%
  mutate(distance = distance(location_x, location_y)) %&gt;%
  mutate(angle = goal_angle(location_x, location_y)) %&gt;%
  mutate(xg = 1/(1+exp(0.0435 + 0.138*distance - 0.0144*angle)))

perc_dist &lt;- data %&gt;%
  group_by(season) %&gt;%
  summarize(perc_xg = quantile(distance, 0.25), n = n())

first &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2010/2011&quot;), aes(x = location_x, y = location_y))

second &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2011/2012&quot;), aes(x = location_x, y = location_y))

third &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2012/2013&quot;), aes(x = location_x, y = location_y))

fourth &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2013/2014&quot;), aes(x = location_x, y = location_y))

fifth &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2014/2015&quot;), aes(x = location_x, y = location_y))

sixth &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2015/2016&quot;), aes(x = location_x, y = location_y))

seventh &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2016/2017&quot;), aes(x = location_x, y = location_y))

eight &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2017/2018&quot;), aes(x = location_x, y = location_y))

nineth &lt;- plot_pitch(type = &quot;offensive_half&quot;, orientation = &quot;vertical&quot;, direction_arrow = FALSE) +
  geom_point(data = data %&gt;% filter(season == &quot;2018/2019&quot;), aes(x = location_x, y = location_y))

(first + second + third) / (fourth + fifth + sixth) / (seventh + eight + nineth)</code></pre>
